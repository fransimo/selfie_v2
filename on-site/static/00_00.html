<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>0.0</title>
    <link href="1080_1920.css" rel="stylesheet">
    <script src="/static/js/html2canvas.min.js">
    </script>

    <script>
      var timeOutVar;

      function changeImage() {
        image = document.getElementById('imgDisp');
        if (image.src.endsWith("videos/00_00_2015_01_30_ecorenal_vesi.gif") ) {
          image.src = "videos/00_01_2019_08_22_ecorenal_vesi.gif";
        } else if (image.src.endsWith("videos/00_01_2019_08_22_ecorenal_vesi.gif") ) {
          image.src = "videos/00_02_2020_10_26_ecorenal_vesi.gif";
        } else {
          image.src = "videos/00_00_2015_01_30_ecorenal_vesi.gif";
        }
        timeOutVar = setTimeout(changeImage, 10000);
      }

      setTimeout(function () {
        changeImage();
      }, 10000);


      document.addEventListener('keydown', (event) => {  // take the selfie and send it to the server
        const keyName = event.key;

        if (keyName === 'Enter') {
          const video = document.querySelector("video");

          const img = document.getElementById("output");
          const canvas = document.createElement("canvas");

          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          canvas.getContext("2d").drawImage(video, 0, 0);
          img.src = canvas.toDataURL("image/png");
          //img.style.filter = "grayscale(1) contrast(150%)";

          //setTimeout(function(){}, 10000)

          html2canvas(document.getElementById("capture")).then(canvas => {
            document.body.appendChild(canvas)

            var dataImage = canvas.toDataURL('image/png', 1.0);
            // https://developergang.com/convert-div-image-using-html2canvas-save-using-ajax-php/
            var imgdata = dataImage.replace(/^data:image\/(png|jpg);base64,/, "");

            var xhr = new XMLHttpRequest();
            var url = "/upload";

            xhr.open("POST", url, true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    var json = JSON.parse(xhr.responseText);
                    console.log(json.email + ", " + json.password);
                }
            };

            var data = JSON.stringify({"selfie": imgdata });
            xhr.send(data);

            canvas.remove();
          } );

          img.src = "";

          return;
        }

      }, false);




  </script>

  </head>
  <body>
    <main id="capture">
      <mirror>
        <video class="webcam" autoplay ></video>
        <img class="webcam" id="output" src=""></img>
      </mirror>
      <script>
        const constraints = {
          audio: false,
          video: {"height":{"exact":240},"width":{"exact":320}}
        };

        const video = document.querySelector("video");

        navigator.mediaDevices.getUserMedia(constraints).then((stream) => {
          video.srcObject = stream;
        });
      </script>

      <img id="imgDisp" class="rinyones" src="videos/00_00_2015_01_30_ecorenal_vesi.gif" />

    </main>
  </body>
</html>

<!--
Result constraints: {"height":{"exact":1080},"width":{"exact":1920}}
main.js:97 Result constraints: {"height":{"exact":480},"width":{"exact":640}}
main.js:124 resize: Actual video dimensions: 640x480px.
main.js:97 Result constraints: {"height":{"exact":720},"width":{"exact":1280}}
main.js:124 resize: Actual video dimensions: 1280x720px.
main.js:97 Result constraints: {"height":{"exact":480},"width":{"exact":640}}
main.js:124 resize: Actual video dimensions: 640x480px.
main.js:97 Result constraints: {"height":{"exact":240},"width":{"exact":320}}
-->
